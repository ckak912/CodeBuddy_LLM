{% if course_basics["exists"] %}
    {% if assignment_basics["exists"] %}
        {% if exercise_basics["exists"] %}
            <link rel="stylesheet" href="/static/css/modal.css">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/introjs.min.css">


            {% if assignment_details["has_timer"] and not is_administrator and not is_instructor and not is_assistant %}
                <link rel="stylesheet" href="/static/css/timer.css">

                <script>
                    function startTimer() {
                        start_time_js = new Date("{{ start_time }}");
                        start_time_js.setMinutes(start_time_js.getMinutes() - start_time_js.getTimezoneOffset());

                        var deadline = start_time_js;
                        deadline.setHours(deadline.getHours() + {{ assignment_details["hour_timer"] }});
                        deadline.setMinutes(deadline.getMinutes() + {{ assignment_details["minute_timer"] }});

                        initializeClock('clockdiv', deadline);
                    }

                    function getTimeRemaining(endtime){
                        const total = Date.parse(endtime) - Date.parse(new Date());
                        const seconds = Math.floor( (total/1000) % 60 );
                        const minutes = Math.floor( (total/1000/60) % 60 );
                        const hours = Math.floor( (total/(1000*60*60)) % 24 );

                        return {
                            total,
                            hours,
                            minutes,
                            seconds
                        };
                    }

                    function initializeClock(id, endtime) {
                        const clock = document.getElementById(id);
                        const hoursSpan = clock.querySelector('.hours');
                        const minutesSpan = clock.querySelector('.minutes');
                        const secondsSpan = clock.querySelector('.seconds');

                        function updateClock(){
                            const t = getTimeRemaining(endtime);
                            hoursSpan.innerHTML = ('00' + t.hours).slice(-2);
                            minutesSpan.innerHTML = ('00' + t.minutes).slice(-2);
                            secondsSpan.innerHTML = ('00' + t.seconds).slice(-2);

                            if (t.total == 120000) {
                                var modal = document.getElementById("time_modal");
                                var span = document.getElementsByClassName("close")[0];
                                var okay_modal = document.getElementById("time_modal_okay_button");

                                modal.style.display = "block";

                                okay_modal.onclick = function() {
                                    modal.style.display = "none";
                                }

                                span.onclick = function() {
                                    modal.style.display = "none";
                                }

                                window.onclick = function(event) {
                                    if (event.target == modal) {
                                        modal.style.display = "none";
                                    }
                                }
                            }

                            if (t.total <= 0) {
                                clearInterval(timeinterval);
                                hoursSpan.innerHTML = '00';
                                minutesSpan.innerHTML = '00';
                                secondsSpan.innerHTML = '00';

                                window.location.replace("/assignment/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}");
                            }
                        }

                        updateClock(); // run function once at first to avoid delay
                        var timeinterval = setInterval(updateClock, 1000);
                    }
                </script>
            {% end %}

            {% if assignment_details["has_timer"] and not is_administrator and not is_instructor and not is_assistant %}
                <div id="clockdiv">
                    <div>
                        <span class="hours"></span>
                        <div class="smalltext">Hours</div>
                    </div>
                    <div>
                        <span class="minutes"></span>
                        <div class="smalltext">Minutes</div>
                    </div>
                    <div>
                        <span class="seconds"></span>
                        <div class="smalltext">Seconds</div>
                    </div>
                </div>
                <br /><br />

                <script>startTimer();</script>
            {% end %}

            {% if assignment_details["due_date"] and assignment_details["due_date_passed"] and assignment_details["view_answer_late"] %}
                <div class='notification is-warning is-light'>The due date for this assignment has passed, but your instructor has enabled viewing the answer.</div>
            {% end %}

            {% if assignment_details["due_date"] and assignment_details["due_date_passed"] and assignment_details["allow_late"] %}
                <div class='notification is-warning is-light'>The due date for this assignment has passed, but you can make late submissions for {{ round(assignment_details["late_percent"] * 100) }}% of the points.</div>
            {% end %}

            {% if is_administrator or is_instructor or is_assistant %}
                <div class="buttons">
                    <a class="button is-dark" href="/edit_exercise/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}">Edit exercise</a>
                </div>
            {% end %}

            <div class="instructions">
                <div id="instructions">
                    {{ exercise_details["instructions"] }}
                    
                    {% if "previous_submission_code" in exercise_details %}
                        <p><a class="button is-primary is-outlined" onclick="copy_code_from_previous_exercise()">Copy code from previous exercise</a></p>
                    {% end %}
                </div>

                {% if exercise_basics["enable_pair_programming"] %}
                    <hr>
                    <p><i style='margin: 0 .5em;' class="fab fa-product-hunt"></i><em>Pair programming is enabled for this exercise.</em></p>
                {% end %}
            </div>

            {% if len(exercise_details["data_files"]) > 0 %}
                <div id="data_file_div" class="top-space">
                <h6>Data files:</h6>

                {% for data_file_index in range(len(exercise_details["data_files"])) %}
                    <p>
                        <!--File name-->
                        <a class="is-family-monospace is-size-5" href="/download_file/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}/{{ sorted(list(exercise_details['data_files'].keys()))[data_file_index] }}">{{ sorted(list(exercise_details["data_files"].keys()))[data_file_index] }}</a>

                        <!--Toggle button-->
                        <a class="button is-white" id="data_button_{{ data_file_index }}" onclick="showHideData('data_panel_{{ data_file_index }}', 'data_button_{{ data_file_index }}')">Show</a>

                        <!--File contents-->
                        <pre id="data_panel_{{ data_file_index }}" hidden>
                            {{ exercise_details["data_files"][sorted(list(exercise_details["data_files"].keys()))[data_file_index]].rstrip("\n") }}
                        </pre>
                    </p>
                {% end %}
                </div>
            {% end %}

            {% if exercise_details["hint"] != "" %}
                <div class="top-space">
                    <button id="hint_button" class="button is-warning" onclick="showHideHint()">Show hint</button>
                </div>

                <div id="hint_text" class="is-hidden hint-text"><p style="margin-top: 10px;">{{ exercise_details["hint"] }}</p></div>
            {% end %}

            <p class="is-primary has-tooltip-multiline has-tooltip-right" data-tooltip="After you have entered your response, click on 'Submit'." />

            <div class="llm_bar">        
                <a class="helpme button is-medium is-primary has-tooltip-multiline has-tooltip-top" id="help" data-tooltip="Clicking me updates the dropdown menu (right) with an explanation to help you if you're stuck!" onclick="generateDropdownItems(1)">Help Me</a>

                <div class="modal" id="loading-indicator">
                    <div class="modal-background" id="modal_background_load"></div>
                    <!-- Spinner animation -->
                    <div class="modal-content" id="loading_content">
                        <div class="spinner"></div>
                        <!-- Loading text -->
                        <p>LLM Tutor Thinking...</p>
                    </div>
                </div>
                <div id="steps_dropdown" class="top-space dropdown is-outlined is-pulled-right margin-bottom my-5 mt-5 has-tooltip-multiline has-tooltip-left" data-tooltip="Here is the dynamic dropdown menu that is colour-coded based on the buttons on the left." style="width: fit-content;  " onclick="toggleDropdown('steps_dropdown')">
                    <div class="dropdown-trigger">
                        <button id="tool_button" class="button is-primary has-text-white" aria-haspopup="true" style="padding: 0 100px;">
                            <span class="aitool">AI Tool</span>
                            <span class="icon-is-small">
                                <i class="fas fa-angle-down" aria-hidden="true" style="margin-left: 10px"></i>
                            </span>
                        </button>
                    </div>
                    <div class="dropdown-menu" id="dropdown-menu" role="menu" style="min-width: 100%;">
                        <div class="dropdown-content" id="dropdown-content" style= "max-height: 350px; overflow-y: auto;">
                    
                        </div>
                    </div>
                </div>
                <style>
                    /* #review_button {
                        position: absolute;
                        bottom: 355px;
                        right: 200px;
                        left: 90%;
                    } */
                </style>
                <a class="steps button is-medium is-dark has-tooltip-multiline has-tooltip-top" id="steps" data-tooltip="Clicking me updates the dropdown (right) with the logical step process for completing this exercise!" onclick="generateDropdownItems(0)">Steps</a>
                <a class="codereviewer button is-medium is-primary is-outlined has-tooltip-multiline has-tooltip-top" id="review_button" data-tooltip="Click this button to review your current implementation and get feedback">Code Reviewer</a>

            </div>

            <script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/intro.min.js"></script>
            <script>
                introJs().setOptions({
                    steps:[{
                        title: 'Welcome to CodeBuddy!',
                        intro: 'This is a quick onboarding experience to show you around ðŸ˜Š'
                    },
                    {
                        element: document.querySelector('.helpme'),
                        intro: 'This button will update the AI tool with an explanation from the model that will compare your current implementation against the intructors full solution.'
                    },               
                    {
                        element: document.querySelector('.steps'),
                        intro: 'This button will update the AI Tool to display the step by step process to complete this exercise'
                    },
                    {
                        element: document.querySelector('.codereviewer'),
                        intro: 'Click this button when you feel like you have achieved the functionality for your current step, and the model will give you some feedback'
                    },
                    {
                        element: document.querySelector('.aitool'),
                        intro: 'This is a dropdown menu that will change based on what you want from the model\n e.g. an explanation for your current implementation, or a step by step process!'
                    }
                ]
                }).start();
            </script>

            <p class="top-space" id="user_code_area">
                <textarea class="textarea is-fullwidth monospace" rows="15" id="user_code">{% if exercise_details["starter_code"] and len(submissions) == 0 %}{{ exercise_details["starter_code"] }}{% end %}</textarea>
                <!--
                {% if assignment_details["enable_help_requests"] %}
                    <div class="buttons is-pulled-right">
                        {% if help_request %}
                            {% if help_request["more_info_needed"] %}
                                <a class="button is-danger is-light" onclick="showHelpRequestModal()">More info needed</a>
                            {% elif same_suggestion %}
                                <a class="button is-success is-light" onclick="showMatchingModal()">Matching suggestion</a>
                            {% elif help_request["approved"] %}
                                <a class="button is-primary" onclick="showSuggestionModal()">View suggestion</a>
                            {% else %}
                                <a class="button is-warning is-light" onclick="showSuggestionModal()">Request pending</a>
                            {% end %}
                        {% else %}
                            <a class="button is-white" onclick="showHelpRequestModal()">Request help</a>
                        {% end %}
                    </div>
                {% end %}
                -->
            </p>

            <div id="saved_div" class="ml-0 mt-0 mr-2 is-pulled-right mt-0 smaller-font"></div>

            <!-- <div class="smaller-font is-pulled-right mt-0 mr-1" style="padding-left: 10px"><em>{{ exercise_basics["title"] }}</em></div> -->

            <!-- <div class="XXX code_reviewer">
                <a class="XXX button is-medium is-primary is-outlined is-pulled-right mt-0 mr-1 margin-bottom my-2 has-tooltip-top has-tooltip-multiline" id="review_button" data-tooltip="Click this button to review your current implementation and get feedback">Code Reviewer</a>
            </div> -->
            <!-- <button class="codereviewer button is-medium is-primary is-outlined is-pulled-right mt-0 mr-1 margin-bottom my-2 has-tooltip-top has-tooltip-multiline" id="review_button" data-tooltip="Click this button to review your current implementation and get feedback">Code Reviewer</button> -->

            <div class="modal" id="code_review_modal">
                <div class="modal-background" id="modal_background"></div>
                <div class="modal-card">
                    <header class="modal-card-head">
                        <p class="modal-card-title" id="step_feedback_title">Here is some helpful feedback:</p>
                    </header>
                    <section class="modal-card-body" id="step_feedback_body"></section>
                    <footer class="modal-card-foot" id="modal-card-footer">
                        <button class="button" onclick="closeModal()">Back</button>
                        <button class="button" onclick="updateModal()">Update Feedback</button>
                    </footer>
                </div>
            </div>

            <!-- Modal for displaying hint response -->
            <div class="modal" id="hint-modal">
                <div class="modal-background"></div>
                <div class="modal-content" id="hint-modal-content">
                    <p id="response-content">LLM Tutor Thinking...</p>
                </div>
                <div class="modal-card-foot" id="hint-modal-foot">
                    <button class="button" id="regenerate-hint-btn">Re-generate Hint</button>
                    <button class="button" id="append-code-btn">Append code to editor</button>
                </div>
            </div>

            <!-- Feedback modal
            <div class="modal" id="feedback_modal">
                <div class="modal-background" id="feedback_modal_background"></div>
                <div class="modal-content">
                    <header class="modal-card-head">
                        <p class="modal-card-title" id="step_feedback_title"></p>
                        <button class="modal-close" onclick="closeFeedbackModal()"></button>
                    </header>
                    <section class="modal-card-body" id="step_feedback_body">
                        Feedback content will be dynamically added here -->
                    <!-- </section>
                    <footer class="modal-card-foot">
                        <button class="button is-success" onclick="viewHint()">View hint</button>
                        <button class="button" onclick="goBack()">Back</button>
                    </footer>
                </div>
            </div> -->

            <style>
            /* CSS styling for the modals */

            #code_review_modal {
                display: none;
                position: fixed;
                z-index: 9998;
                top: 50%; /* Center vertically */
                left: 50%; /* Center horizontally */
                transform: translate(-50%, -50%);
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.01);
                overflow:hidden;
            }

            #modal-card-body {
                position: relative;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: white;
                padding: 20px;
                border-radius: 10px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
            }

            #modal-card-footer {
                position: relative;
                margin-bottom: 25%;
                display: flex;
                justify-content: flex-start;
            }

            .modal-close {
                position: relative;
                top: 0px;
                right: 0px;
                left: 0px;
                bottom: 0px;
                background-color: transparent;
                border: none;
                cursor: pointer;
            }

            .table {
                border-radius: 4px;
            }

            .is-rounded-top {
                border-top-left-radius: 4px;
                border-top-right-radius: 4px;
            }

            .select-text {
                font-weight: bold;
                padding: 10px;
            }
            </style>


            <style>
                /* CSS for the spinner animation */
                .spinner {
                    border: 4px solid rgba(255, 255, 255, 0.3);
                    border-radius: 50%;
                    border-top: 4px solid #3498db; /* Change the color to your preference */
                    width: 40px;
                    height: 40px;
                    animation: spin 1s linear infinite; /* Spinner animation */
                    margin: 0 auto;
                }

                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }

                /* CSS for the loading modal */
                #loading-indicator {
                    display: none;
                    position: fixed;
                    z-index: 9999;
                    top: 50%; /* Center vertically */
                    left: 50%; /* Center horizontally */
                    transform: translate(-50%, -50%);
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
                    align-items: center;
                    justify-content: center;
                }

                /* Additional styles for the loading modal content */
                #loading-content {
                    background-color: white;
                    padding: 20px;
                    border-radius: 10px;
                    max-width: 300px; /* Adjust the width as needed */
                }

                /* CSS for the loading modal text alignment */
                #loading-indicator #loading_content p {
                    text-align: center;
                }


            </style>

            <style>

                /* CSS for the hint modal */
                #hint-modal {
                    display: none;
                    position: fixed;
                    z-index: 9998;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    width: 100%; /* Adjust the width as needed */
                    height: 100%; /* Maximum width */
                    background-color: rgba(0, 0, 0, 0.5);
                    overflow: auto;
                    border-radius: 10px;
                }

                #hint-modal-content {
                    background-color: white;
                    padding: 20px;
                    margin-bottom: 60px; /* Height of the footer */
                }

                #hint-modal-foot {
                    display: flex;
                    justify-content: center; /* Center buttons horizontally */
                    position: absolute;
                    bottom: 0;
                    left: 0;
                    right: 0;
                    padding: 10px;
                    background-color: #f5f5f5; /* Background color for the footer */
                    border-radius: 0 0 10px 10px; /* Rounded corners for the footer */
                }

                /* Style the buttons in the footer */
                #hint-modal-foot .button {
                    margin: 0 10px; /* Add some spacing between buttons */
                }


            </style>

            <script>
                // Get the dropdown element
                const dropdown = document.getElementById('steps_dropdown');

                // Display the loading indicator when the AJAX request starts
                $('#loading-indicator').hide();

                let steps = {};

                let stepComplete = [];

                let full_solution = ``;

                var count = 1;

                let stepsUrl = '';

                let solutionUrl = '';

                async function getSteps() {
                    var current_exercise =  {{exercise_basics['id']}};

                    if (current_exercise === 1) {
                        stepsUrl = '/static/step_process_avggrade.json';
                        solutionUrl = '/static/full_solution_avggrade.txt';
                    }
                    else if (current_exercise === 2) {
                        stepsUrl = '/static/step_process_palindrome.json';
                        solutionUrl = '/static/full_solution_palindrome.txt';
                    }
                    else if (current_exercise === 3) {
                        stepsUrl = '/static/step_process_interest.json';
                        solutionUrl = '/static/full_solution_interest.txt';
                    }
                    try {
                        // Make an HTTP request to the exercise endpoint
                        const response = await fetch(solutionUrl);
    
                        // Check the response status
                        if (!response.ok) {
                            throw new Error('Failed to fetch exercise data');
                        }
                        // Parse the response data
                        full_solution = await response.text();
                        
                    } catch (error) {
                        console.error('Error:', error.message);
                    }
                    try {
                        // Make an HTTP request to the exercise endpoint
                        const response = await fetch(stepsUrl);
    
                        // Check the response status
                        if (!response.ok) {
                            throw new Error('Failed to fetch exercise data');
                        }
                        // Parse the response data
                        steps = await response.json();
                        
                    } catch (error) {
                        console.error('Error:', error.message);
                    }  
                    
                    Object.entries(steps).forEach(function ([stepNumber, stepContent]) { 
                        stepComplete.push(false);
                    });
                }

                getSteps();
                generateDropdownItems(0);


                // Function to generate dropdown items dynamically
                function generateDropdownItems(tool_feature) {
            
                    // Generate modal body content
                    var modalBody = document.getElementById("step_feedback_body");
                    modalBody.innerHTML = ""; // Clear existing content

                    Object.keys(steps).forEach(function (stepNumber) {
                    var paragraph = document.createElement("strong");
                    paragraph.textContent = "Step " + stepNumber + " Feedback:";
                    modalBody.appendChild(paragraph);

                    var content = document.createElement("p");
                    content.textContent = "-------------------------------";
                    content.id = "step" + stepNumber + "_content"; // Assign a unique ID for each step's content
                    modalBody.appendChild(content);


                    const hrFeedback = document.createElement("hr");
                    hrFeedback.className = "dropdown-divider";
                    hrFeedback.style.flexBasis = "100%";
                    hrFeedback.style.width = "100%";
                    modalBody.appendChild(hrFeedback);

                    });


                    var dropdownContent = document.getElementById("dropdown-content");

                    if (tool_feature === 0) {

                        // Update the color of the dropdown menu and the button
                        var buttonElement = document.getElementById('tool_button');
                        
                        if (buttonElement.classList.contains('is-primary')) {
                            buttonElement.classList.remove('is-primary');
                        }
                        buttonElement.classList.add('is-dark');


                        dropdownContent.innerHTML = "";

                        Object.entries(steps).forEach(function ([stepNumber, stepContent]) {  
                        var div = document.createElement("div");
                        div.className = "dropdown-item";
                        div.style.flex = "1";

                        var p = document.createElement("p");
                        p.style.textAlign = "justify";
                        if (stepComplete[stepNumber - 1] === true) {
                            p.style.textDecoration = "line-through";

                        }
                        else {
                            p.style.textDecoration = "none";
                        }
                        p.textContent = stepNumber + ". " + stepContent;

                        div.appendChild(p);
                        dropdownContent.appendChild(div);

                        const hrSteps = document.createElement("hr");
                        hrSteps.className = "dropdown-divider";
                        hrSteps.style.flexBasis = "100%";
                        hrSteps.style.width = "100%";
                        dropdownContent.appendChild(hrSteps);
                        });
                        
                    } else if (tool_feature === 1) {

                        // Update the color of the dropdown menu and the button
                        var buttonElement = document.getElementById('tool_button');
                        
                        if (buttonElement.classList.contains('is-dark')) {
                            buttonElement.classList.remove('is-dark');
                        }
                        buttonElement.classList.add('is-primary');

                        // Clear existing options
                        dropdownContent.innerHTML = "";

                        // Create 'What's Next' feature
                        var whatsNextDiv  = document.createElement("div");
                        whatsNextDiv.className = "dropdown-item";
                        whatsNextDiv.style.flex = "1";

                        var whatsNextP = document.createElement("p");
                        whatsNextP.style.textAlign = "justify";
                        whatsNextP.textContent = "The generated pseudo code will go here";
                        whatsNextP.id = "id_whatsnext"

                        whatsNextDiv.appendChild(whatsNextP);
                        dropdownContent.appendChild(whatsNextDiv);

                        const hrNext = document.createElement("hr");
                        hrNext.className = "dropdown-divider";
                        hrNext.style.flexBasis = "100%";
                        hrNext.style.width = "100%";

                        dropdownContent.appendChild(hrNext);

                        // Create the hint button
                        const hintButton = document.createElement("hint-button");
                        hintButton.className = "button is-primary is-small";
                        hintButton.style.width = "100%";
                        hintButton.style.textAlign = "center";
                        hintButton.id = "hint_button_id";
                        hintButton.textContent = "Generate Hint (ONCE PER STEP)";

                        const hintElement = document.createElement("div");
                        hintElement.className = "dropdown-item";
                        hintElement.style.flex = "1";

                        hintElement.appendChild(hintButton);
                        dropdownContent.appendChild(hintElement);



                        const hrHint = document.createElement("hr");
                        hrHint.className = "dropdown-divider";
                        hrHint.style.flexBasis = "100%";
                        hrHint.style.width = "100%";
                        dropdownContent.appendChild(hrHint);

                        generate_help()

                    }

                        
                }
                
                // // function to get user code from editor
                // function get_user_code() {
                //     user_code = editor.getSelectedText().trim();

                //     if (user_code == "")
                //         user_code = editor.getValue().trim();

                //     return user_code;
                // }

                // Open the hint modal and populate its content
                function openHintModal(responseContent) {
                    var modal = document.getElementById('hint-modal');
                    var contentElement = document.getElementById('response-content');
                    var regenerateHintBtn = document.getElementById('regenerate-hint-btn');
                    var appendCodeBtn = document.getElementById('append-code-btn');

                    // Set the content of the modal
                    contentElement.textContent = responseContent;

                    // Add event listener to the "Re-generate Hint" button
                    regenerateHintBtn.addEventListener('click', function () {
                        responseContent = ""
                        handleHintButtonClick();
                        modal.style.display = 'none';
                    });

                    // Add event listener to the "Append code to editor" button
                    appendCodeBtn.addEventListener('click', function () {
                        editor.setValue(editor.getValue() + '\n' + responseContent);
                        modal.style.display = 'none';
                    });

                    // Show the modal
                    modal.style.display = 'block';
                }


                    
                async function generate_help() {
                    // TODO: integrate this parallel call to the pseudo and hint code endpoint 
                    var pseudoCodeUrl = `/exercise_pseudo_code/{{ exercise_basics['id'] }}/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}`;

                    // Display the loading indicator when the AJAX request starts
                    $('#loading-indicator').show();
                    try {
                        
                        // Fetch the step process asynchronously
                        const step_process = JSON.stringify(steps);
                        var userCode = get_user_code();
                        if (user_code == "") {
                            // Handle the case where the user code is empty
                            // might need an error message here
                            return;
                        }
                        // Create an object with the data to send in the AJAX request
                        const postData = {"user_code": user_code, "full_solution": full_solution};
                        var hintBtn = document.getElementById("hint_button_id");

                        $.ajax({
                            type: 'POST', // Changed request type to POST
                            url: pseudoCodeUrl,
                            data: postData,
                            async: true,
                        })
                        .done(function(pseudoCodeResponse) {
                            var jsonPseudoCode = JSON.parse(pseudoCodeResponse);
                            whatsNextContent = document.getElementById('id_whatsnext');
                            whatsNextContent.textContent = jsonPseudoCode;
                        })
                        .fail(function(error) {
                                console.error("AJAX error:", error);
                        })
                        .always(function() {
                            // Hide the loading indicator when the request is complete, whether it succeeds or fails
                            $('#loading-indicator').hide();
                        })

                        // Attach the function to the hintBtn.onclick event
                        hintBtn.onclick = handleHintButtonClick;

                    } catch (error) {
                    console.error("Error:", error);
                    // Handle the error here if needed
                    }
                }

                // Wait for the DOM to be fully loaded
                document.addEventListener("DOMContentLoaded", function () {
                    generateDropdownItems(0);
                });


                async function handleHintButtonClick() {

                    $('#loading-indicator').show();
                    var hintCodeUrl = `/exercise_hint_code/{{ exercise_basics['id'] }}/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}`;

                    var userCode = get_user_code();
                    if (user_code == "") {
                        // Handle the case where the user code is empty
                        // might need an error message here
                        return;
                    }
                    // Create an object with the data to send in the AJAX request
                    const postData = {"user_code": user_code, "full_solution": full_solution};

                    try {
                        $.when(
                                $.ajax({
                                    type: 'POST', // Changed request type to POST
                                    url: hintCodeUrl,
                                    data: postData,
                                    async: true,
                                })
                            )
                            .done(function(hintCodeResponse) {
                                try {

                                    openHintModal(JSON.parse(hintCodeResponse));

                                } catch (e) {
                                    console.error("Error parsing JSON response:", e)
                                }
                            })
                            .fail(function(error) {
                                console.error("AJAX error:", error);
                            })
                            .always(function() {
                                $('#loading-indicator').hide();
                            })

                    } catch (error) {
                    console.error("Error:", error);
                    // Handle the error here if needed
                    }

                }

            // Function to open the modal
            function openModal() {
                var modal = document.getElementById('code_review_modal');
                modal.style.display = 'block';
                stepComplete[0] = true;
                document.getElementById('modal_background').addEventListener('click', closeModal);
            }

            // Function to close the modal
            function closeModal() {
                var modal = document.getElementById('code_review_modal');
                modal.style.display = 'none';
                document.getElementById('modal_background').removeEventListener('click', closeModal);
            }



            // async function get_static_step_process() {
            //     try {
            //             // Make an HTTP request to the exercise endpoint
            //             const response = await fetch('/static/step_process.json');

            //             // Check the response status
            //             if (!response.ok) {
            //                 throw new Error('Failed to fetch exercise data');
            //             }
            //             // Parse the response data
            //             steps = await response.json();

                        
            //         } catch (error) {
            //             console.error('Error:', error.message);
            //         }
                    
            //     return steps;
            // }

            function extractFeedback(text) {
                var regex = /(\d+):([\s\S]*?)(?=\d+:|$)/g;
                var feedback = {};
                var match;

                while ((match = regex.exec(text)) !== null) {
                    var stepNumber = match[1];
                    var feedbackContent = match[2].trim(); // Trim to remove extra spaces
                    feedback[stepNumber] = feedbackContent;
                }

                return feedback;
            }            

            // Function to update feedback
            async function updateModal() {
                $('#loading-indicator').show();
                var url = `/exercise_feedback/{{ exercise_basics['id'] }}/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}`;
                //get the user code
                var user_code = get_user_code();
                if (user_code == "") {
                    // Handle the case where the user code is empty
                    // might need an error message here
                    return;
                }
                try {
                    // Fetch the step process asynchronously
                    const step_process = JSON.stringify(steps);
                    // Create an object with the data to send in the AJAX request
                    const postData = {"user_code": user_code, "step_process": step_process, "full_solution": full_solution};
                    
                    // Make the AJAX request
                    $.ajax({
                        type: 'POST', // Changed request type to POST
                        url: url,
                        data: postData,
                        async: true,
                    }).done(function(response) {
                        try {
                            var feedbackText = JSON.parse(response);

                            var feedback = extractFeedback(feedbackText);

                            // Now, the feedback object contains step numbers as keys and feedback content as values
                            console.log(feedback);

                            Object.entries(feedback).forEach(function ([stepNumber, feedbackContent]) {
                                var currentID = "step" + stepNumber + "_content";
                                var currentFeedback = document.getElementById(currentID);
                                currentFeedback.textContent = feedbackContent;
                                if (feedbackContent.includes("You have completed")) {
                                    stepComplete[stepNumber - 1] = true;

                                } else {
                                    stepComplete[stepNumber - 1] = false;
                                }
                            });

                        } catch (error) {
                            console.error("JSON Parsing error:", error);
                        }
                    })
                    .fail(function(error) {
                        console.error("AJAX error:", error);
                        // Handle the error message here if needed
                    })
                    .always(function () {
                        $('#loading-indicator').hide();
                    });
                } catch (error) {
                    console.error("Error:", error);
                    // Handle the error here if needed
                }
            };


             // Function to close the modal after a slight delay
            function closeDelayedModal() {
                setTimeout(closeModal, 50); // Adjust the delay time as needed
            }
            
            // Function to close the feedback modal
            function closeFeedbackModal() {
                var feedbackModal = document.getElementById('feedback_modal');
                feedbackModal.style.display = 'none';
                document.getElementById('feedback_modal_background').removeEventListener('click', closeFeedbackModal);
            }

            // Event listener for code review button
            var reviewButton = document.getElementById('review_button');
            if (reviewButton) {
                reviewButton.addEventListener('click', openModal);
            }

            // Function to open the feedback modal
            function openFeedbackModal() {

                // Show the feedback modal
                modal.classList.add('is-active')

            }

            // Function to check step functionality and display feedback
            function checkStepFunctionality() {
                // let feedback = {};
                // var reviewButton = document.getElementById('review_button');
                // var url = `/exercise_feedback/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}`;

                // reviewButton.onclick = function() {
                //     $.ajax({
                //         type: 'GET',
                //         url: url,
                //     })
                //     .done(function(response) {
                //         try {
                //             console.log(response);
                //             feedback = JSON.parse(response);
                            

                //             Object.entries(feedback).forEach(function ([stepNumber, feedbackContent]) {
                //                 var currentID = "step" + stepNumber + "_content";
                //                 var currentFeedback = document.getElementById(currentID);
                //                 currentFeedback.textContent = feedbackContent;
                //             });

                //         } catch (error) {
                //             console.error("JSON Parsing error:", error);
                //         }
                //     })
                //     .fail(function(error) {
                //         console.error("AJAX error:", error);
                //         // Handle the error message here if needed
                //     });
                // };
            }
            </script>

            <div id="saved_div" class="ml-0 mt-0 mr-2 is-pulled-right mt-0 smaller-font"></div>

            <div class="smaller-font is-pulled-right mt-0 mr-1"><em>{{ exercise_basics["title"] }}</em></div>

            <div class="buttons">
                <a class="button is-medium is-dark" id='submit_button'>Submit</a>
                {% if exercise_details["back_end"] != "not_code" and not exercise_details["allow_any_response"] %}
                    <a class="button is-medium is-primary is-outlined" onclick='run_code(true)' id='run_button'>Run</a>
                {% end %}

                {% if exercise_details["allow_any_response"] or exercise_details["back_end"] == "not_code" %}
                    <p class="is-primary has-tooltip-multiline has-tooltip-right" data-tooltip="After you have entered your response, click on 'Submit'." />
                {% else %}
                    <p class="is-primary has-tooltip-multiline has-tooltip-right" data-tooltip="When you are ready to test your solution against the expected output, click on 'Submit'. If you would like to see the output of your solution without officially submitting it, click on 'Run'. If you highlight a section of code and hit the Tab button, it will indent all lines of code in the block. If you hit Shift-Tab, it will reduce the indentation. There is also an option for commenting sections of code. To do this, highlight the code you wish to comment; then enter Command + / (Mac) or Control + / (Windows) to comment the code. If it is already commented, this will uncomment the code." />
                {% end %}

                <span class="icon mt-0">
                    <i class="far fa-question-circle fa-1x"></i>
                </span>
            </div>

            <div id="max_submissions_message"></div>

            {% if assignment_details["due_date"] and assignment_details["due_date_passed"] %}
                {% if not assignment_details["allow_late"] %}
                    <script>
                        document.getElementById("submit_button").disabled = true;
                    </script>
                {% end %}

                {% if assignment_details["view_answer_late"] %}
                    <div class='notification is-warning'>
                        <p>Click <a style='color:#2166ac' href="/view_instructor_solution/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}">here</a> to view the instructor's solution.
                        </p>
                    </div>
                {% end %}
            {% end %}

            <p id="test_outputs"></p>

            <p id="result_message"></p>

            <p id="submissions"></p>

            {% if len(exercise_details["credit"]) > 0 %}
                <div class="front-row-container">
                    <p style="padding-right: 5px;"><em>Credit: </em></p>
                    <p><em>{{ exercise_details["credit"] }}</em></p>
                </div>
            {% end %}

            <div class="buttons">
                {% if prev_exercise %}
                    <a class="button is-outlined" href="/exercise/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ prev_exercise['id'] }}">Previous exercise</a>
                {% end %}

                {% if next_exercise %}
                    <a class="button is-outlined" href="/exercise/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ next_exercise['id'] }}">Next exercise</a>
                {% end %}

                <!--<button class="button is-light is-pulled-right" onclick="showLinkModal()">Share</button>-->
            </div>

            <div id="submit_exercise_modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h6 style="display:inline">Pair programming:</h6>
                    <label class="has-tooltip-multiline has-tooltip-right" data-tooltip="If using pair programming for this exercise, enter the name of your partner here.">
                        <i class="far fa-question-circle"></i>
                    </label><br />

                    <div id="submit_exercise_modal_message"></div>

                    <div id="partner_selection">
                        <p>Select your pair programming partner here. If you are working on the exercise without a partner, leave this field blank.</p>
                        {% if users %}
                            <input class="space_div input is-primary" list="users_list" id="partner_name" placeholder="Enter partner's name here...">
                            <datalist id="users_list">
                                {% for user_name in users %}
                                    <option value="{{ user_name }}"></option>
                                {% end %}
                            </datalist>
                        {% else %}
                            <p>There are no other registered students in this course, so your only option is to leave this field blank.</p>
                        {% end %}

                        <input type="hidden" id="partner_id" />
                    </div>

                    <p class="buttons">
                        <a id="submit_cancel_button" class="modal-button button is-light">Cancel</a>
                        <a id="modal_submit_button" class="modal-button button is-dark">Submit</a>
                    </p>
                </div>
            </div>

            <div id="time_modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <p>You have less than 2 minutes remaining. If you are still working, submit a solution to avoid losing your work.</p>
                    <p><button class="button is-dark" id="time_modal_okay_button">Okay</button></p>
                </div>
            </div>

            <!--<div id="share_modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <p>Share this link with an instructor or assistant:</p>
                    <input class="input is-medium is-primary" type="text" id="share_link" value="https://{{ domain }}/student_exercise/{{ course_basics['id'] }}/{{ assignment_basics['id'] }}/{{ exercise_basics['id'] }}/{{ user_info['user_id'] }}" readonly>
                    <button class="modal-button button is-dark" onclick="copyLink()">Copy Link</button>
                </div>
            </div>-->

            <!--<div id="help_request_modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    {% if help_request and help_request["more_info_needed"] %}
                        <p><strong>An instructor or assistant has requested more info from you about your help request.</strong></p>
                        {% if help_request["suggestion"] %}
                            <p>Comment made by your instructor/assistant:<br />
                            <span class="green-text">{{ help_request["suggestion"] }}</span></p>
                        {% end %}
                        <p>Please update your comment to help us better understand what you need help with:</p>
                    {% else %}
                        <p><strong>Submit a help request so an instructor or assistant can review your code/output and make a suggestion.</strong></p>
                        <p>Please write a comment to help us better understand what you need help with:</p>
                    {% end %}
                    <textarea class="textarea is-primary is-fullwidth monospace" id="student_comment" name="student_comment">{% if help_request and help_request["more_info_needed"] %}{{ help_request["student_comment"] }}{% end %}</textarea>
                    <p class="buttons">
                        <a id="cancel_request_button" class="modal-button button is-light">Cancel</a>
                        <a id="submit_request_button" class="modal-button button is-dark">Submit</a>
                    </p>
                </div>
            </div>

            <div id="matching_modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <p><strong>A student in this class previously submitted a help request with the same output as your request. The instructor/assistant made this suggestion:</strong></p>
                    <span class="green-text">{{ same_suggestion }}</span></p>
                    <p>If this suggestion is helpful, do you want to cancel your own request?</p>
                    <p class="buttons">
                        <a id="delete_request_button" class="modal-button button is-light">Cancel request</a>
                        <a id="keep_request_button" class="modal-button button is-dark">Keep request</a>
                    </p>
                </div>
            </div>

            <div id="suggestion_modal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <p>Your comment from the help request:</p>
                    <textarea class="textarea is-primary monospace text-18" rows="3">{% if help_request and help_request["student_comment"] %}{{ help_request["student_comment"] }}{% end %}</textarea>
                    <br><p>Instructor's suggestion:</p>
                    <textarea class="textarea is-primary monospace text-18" rows="3">{% if help_request and help_request["suggestion"] %}{{ help_request["suggestion"] }}{% else %}No suggestion has been made yet.{% end %}</textarea>
                </div>
            </div>-->

            <script>
                ace.require("ace/ext/language_tools");

                var editor = ace.edit("user_code", {
                    theme: "ace/theme/{{ user_info['ace_theme'] }}",
                    autoScrollEditorIntoView: false,
                    minLines: 20,
                    fontSize: "12pt"
                });

                editor.setHighlightActiveLine(false);
                editor.setShowPrintMargin(false);

                {% if user_info['enable_vim'] %}
                   editor.setKeyboardHandler("ace/keyboard/vim");
                {% end %}

                {% if exercise_details["back_end"] == "not_code" %}
                    editor.session.setUseWrapMode(true);
                {% else %}
                    {% if user_info["use_auto_complete"] %}
                        editor.setOptions({
                            enableBasicAutocompletion: false,
                            enableSnippets: true,
                            enableLiveAutocompletion: true
                        });
                    {% end %}
                {% end %}

                editor.focus();
                editor.getSession().setMode("{{ code_completion_path }}");

                submitButton = document.getElementById("submit_button");

                {% if exercise_details["enable_pair_programming"] %}
                      if (submitButton != null)
                          submitButton.onclick = function() {
                              showSubmitModal()
                      }
                {% else %}
                    if (submitButton != null) {
                        submitButton.onclick = function() {
                            if (submitButton.disabled)
                                showErrorMessage("You are not allowed to make a submission because the due date has passed.");
                            else
                                submit()
                        }
                    }
                {% end %}

                const tests = {{ jsonify(tests) }};

                var submissions = {{ jsonify(submissions) }};
                var presubmission = {{ jsonify(presubmission) }};

                show_past_submissions();

                if (submissions.length == 0) {
                    showTestOutputs(null, false);

                    if (presubmission) {
                        editor.focus();
                        editor.setValue(presubmission, 1);
                    }
                }
                else {
                    var latest_submission = submissions[submissions.length - 1];

                    // Set editor value to presubmission if the presubmission is different than the latest submission code.
                    if (presubmission && presubmission != latest_submission.code) {
                        editor.focus();
                        editor.setValue(presubmission, 1);
                    }
                    else {
                        get_submission(latest_submission.id, false, true);
                    }
                }

                let codeChanged = false;
                window.wasUserChange = true;

                // editor.session.on('change', function(delta) {
                editor.on('change', function() {
                    if (window.wasUserChange){
                        codeChanged = true;
                        saved_div.innerHTML = `<span class="icon mt-0 ml-1">
                            <i class="far fa-save fa-2x" style="cursor: pointer;"  onclick="save_presubmission();editor.focus();"></i>
                        </span>`;
                    }
                });

                // Autosave if code has changed
                setInterval(function() {
                    if (codeChanged) {
                        save_presubmission();
                    }
                }, 60000);

                {% if check_for_restrict_other_assignments %}
                    setInterval(isTakingRestrictedAssignment, 60000);
                {% end %}
            </script>
        {% else %}
            <p>This exercise does not exist.</p>
        {% end %}
    {% else %}
        <p>This assignment does not exist.</p>
    {% end %}
{% else %}
    <p>This course does not exist.</p>
{% end %}